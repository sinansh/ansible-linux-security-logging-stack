# Managed by Ansible (roles/auditd). Test on non-production first.

# Remove all existing rules
-D

# Buffer size
-b 8192

# Failure mode (1: print error messages)
-f 1

# Continue loading rules even if there are errors
-i

##########################################
####  Self-monitoring
##########################################

# Watch audit tooling and configuration
-w /etc/audit/ -p wa -k auditconfig
-w /etc/libaudit.conf -p wa -k auditconfig
-w /etc/audisp/ -p wa -k audispconfig
-w /sbin/auditctl -p x -k audittools
-w /sbin/auditd -p x -k audittools

# Monitor access to audit logs (Reduced noise: removed write watch on log file itself)
# -w /var/log/audit/ -p wa -k audit_log_access

##########################################
####  Execution monitoring (more selective)
##########################################

# Root commands (DEPRECATED: Handled by Sysmon ProcessCreate ID 1)
# -a always,exit -F arch=b64 -F euid=0 -S execve -k root_command
# -a always,exit -F arch=b32 -F euid=0 -S execve -k root_command

# Optional: comment out if too noisy
# Real users (uid >= 1000) - may be very noisy in busy systems
# (DEPRECATED: Handled by Sysmon ProcessCreate ID 1)
# -a always,exit -F arch=b64 -F euid>=1000 -S execve -k user_command
# -a always,exit -F arch=b32 -F euid>=1000 -S execve -k user_command

##########################################
####  Account and auth
##########################################

-w /etc/group -p wa -k group_modifications
-w /etc/passwd -p wa -k passwd_modifications
-w /etc/gshadow -p wa -k group_modifications
-w /etc/shadow -p wa -k passwd_modifications
-w /etc/security/opasswd -p wa -k passwd_modifications

-w /etc/sudoers -p wa -k sudo_modifications
-w /etc/sudoers.d -p wa -k sudo_modifications
-w /usr/bin/sudo -p x -k sudo_execution

-w /usr/bin/passwd -p x -k passwd_modifications

##########################################
####  Host & network config
##########################################

-a always,exit -F arch=b32 -S sethostname -S setdomainname -k network_modifications
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k network_modifications

-w /etc/hosts -p wa -k network_modifications
-w /etc/sysconfig/network -p wa -k network_modifications
-w /etc/network/ -p wa -k network_modifications
-a always,exit -F dir=/etc/NetworkManager/ -F perm=wa -k network_modifications

##########################################
####  System state
##########################################

-w /sbin/shutdown -p x -k system_state_modifications
-w /sbin/poweroff -p x -k system_state_modifications
-w /sbin/reboot -p x -k system_state_modifications
-w /sbin/halt -p x -k system_state_modifications
-w /usr/sbin/runlevel -p x -k system_state_modifications

##########################################
####  Kernel modules
##########################################

-a always,exit -F perm=x -F auid!=-1 -F path=/sbin/insmod -k kernel_modules
-a always,exit -F perm=x -F auid!=-1 -F path=/sbin/modprobe -k kernel_modules
-a always,exit -F perm=x -F auid!=-1 -F path=/sbin/rmmod -k kernel_modules
-a always,exit -F perm=x -F auid!=-1 -F path=/sbin/kmod -k kernel_modules

-w /etc/modprobe.conf -p wa -k kernel_modules

##########################################
####  PAM and auth logs
##########################################

-w /etc/pam.d/ -p wa -k pam_modifications
-w /etc/security/limits.conf -p wa -k pam_modifications

-w /var/log/faillog -p wa -k login_modifications
-w /var/log/lastlog -p wa -k login_modifications
-w /var/log/tallylog -p wa -k login_modifications

##########################################
####  Suspicious execs & commands
##########################################

# Bu binary'ler Sysmon ProcessCreate ile zaten görünür, o yüzden çakışmayı azaltmak için kapatıldı
# -w /usr/bin/wget -p x -k suspect_activity
# -w /usr/bin/curl -p x -k suspect_activity
# -w /bin/nc -p x -k suspect_activity
# -w /usr/bin/ssh -p x -k suspect_activity

##########################################
####  Injection / Ptrace detection
##########################################

-a always,exit -F arch=b32 -S ptrace -k suspect_activity
-a always,exit -F arch=b64 -S ptrace -k suspect_activity

##########################################
####  Package, systemd, cron, fstab
##########################################

# Debian/Ubuntu package tools and logs (Already covered by Sysmon ProcessCreate)
# -w /usr/bin/dpkg -p x -k pkg_management
# -w /usr/bin/apt-get -p x -k pkg_management
# -w /usr/bin/apt -p x -k pkg_management
-w /var/log/dpkg.log -p wa -k pkg_logs
-w /var/log/apt/history.log -p wa -k pkg_logs

# RPM-based package tools and logs (Already covered by Sysmon ProcessCreate)
# -w /usr/bin/rpm -p x -k pkg_management
# -w /usr/bin/yum -p x -k pkg_management
# -w /usr/bin/dnf -p x -k pkg_management
-w /var/log/yum.log -p wa -k pkg_logs

-w /etc/systemd/system/ -p wa -k systemd_unit_changes
-w /lib/systemd/system/ -p wa -k systemd_unit_changes

-w /etc/fstab -p wa -k fstab_changes
-a always,exit -F arch=b64 -S mount -k mounts
-a always,exit -F arch=b32 -S mount -k mounts

-w /etc/crontab -p wa -k cron_changes
-w /etc/cron.d/ -p wa -k cron_changes
-w /usr/bin/crontab -p x -k cron_exec
