---
# Install SysmonForLinux using the official Microsoft packages

- name: Ensure directory for sysmon config exists
  file:
    path: "{{ sysmon_config_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

# ----- Debian / Ubuntu -----
- name: Register Microsoft package feed (Ubuntu)
  shell: |
    if [ ! -f /etc/apt/sources.list.d/microsoft-prod.list ]; then
      wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb" \
        -O /tmp/packages-microsoft-prod.deb
      dpkg -i /tmp/packages-microsoft-prod.deb
    fi
  args:
    warn: false
  become: true
  when:
    - ansible_facts['os_family'] == 'Debian'
    - (ansible_distribution | lower) == 'ubuntu'

- name: Register Microsoft package feed (Debian)
  shell: |
    if [ ! -f /etc/apt/sources.list.d/microsoft-prod.list ]; then
      wget -q "https://packages.microsoft.com/config/debian/$(. /etc/os-release && echo ${VERSION_ID%%.*})/packages-microsoft-prod.deb" \
        -O /tmp/packages-microsoft-prod.deb
      dpkg -i /tmp/packages-microsoft-prod.deb
    fi
  args:
    warn: false
  become: true
  when:
    - ansible_facts['os_family'] == 'Debian'
    - (ansible_distribution | lower) == 'debian'

- name: Update apt cache
  apt:
    update_cache: yes
  become: true
  when:
    ansible_facts['os_family'] == 'Debian'

- name: Install sysmonforlinux package (Debian/Ubuntu)
  package:
    name: sysmonforlinux
    state: present
  become: true
  when:
    ansible_facts['os_family'] == 'Debian'

# ----- RHEL / CentOS -----
- name: Register Microsoft package feed (RHEL/CentOS)
  shell: |
    if ! rpm -q packages-microsoft-prod >/dev/null 2>&1; then
      rpm -Uvh "https://packages.microsoft.com/config/rhel/$(. /etc/os-release && echo ${VERSION_ID%%.*})/packages-microsoft-prod.rpm"
    fi
  args:
    warn: false
  become: true
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - (ansible_distribution | lower) not in ['fedora']

- name: Install sysmonforlinux package (RHEL/CentOS)
  package:
    name: sysmonforlinux
    state: present
  become: true
  when:
    ansible_facts['os_family'] == 'RedHat'

# ----- Fedora -----
- name: Register Microsoft package feed (Fedora)
  shell: |
    if ! rpm -q packages-microsoft-prod >/dev/null 2>&1; then
      rpm -Uvh "https://packages.microsoft.com/config/fedora/$(rpm -E %fedora)/packages-microsoft-prod.rpm"
    fi
  args:
    warn: false
  become: true
  when:
    (ansible_distribution | lower) == 'fedora'

- name: Install sysmonforlinux package (Fedora)
  package:
    name: sysmonforlinux
    state: present
  become: true
  when:
    (ansible_distribution | lower) == 'fedora'

# ----- openSUSE / SLES -----
- name: Register Microsoft repo and import key (openSUSE/SLES)
  shell: |
    zypper install -y libicu || true
    rpm --import "https://packages.microsoft.com/keys/microsoft.asc" || true
    if [ ! -f /etc/zypp/repos.d/microsoft-prod.repo ]; then
      wget -q "https://packages.microsoft.com/config/opensuse/15/prod.repo" -O /tmp/prod.repo
      mv /tmp/prod.repo /etc/zypp/repos.d/microsoft-prod.repo
      chown root:root /etc/zypp/repos.d/microsoft-prod.repo
    fi
  args:
    warn: false
  become: true
  when:
    (ansible_distribution | lower) in ['opensuse','sles']

- name: Install sysmonforlinux package (openSUSE/SLES)
  package:
    name: sysmonforlinux
    state: present
  become: true
  when:
    (ansible_distribution | lower) in ['opensuse','sles']

# ----- Systemd unit handling -----
- name: Check for existing sysmon unit in /etc/systemd/system
  stat:
    path: /etc/systemd/system/sysmon.service
  register: sysmon_unit_etc
  become: true

- name: Check for existing sysmon unit in /lib/systemd/system
  stat:
    path: /lib/systemd/system/sysmon.service
  register: sysmon_unit_lib
  become: true

- name: Deploy sysmon systemd unit if none exists
  template:
    src: sysmon.service.j2
    dest: /etc/systemd/system/sysmon.service
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd
  become: true
  when: not (sysmon_unit_etc.stat.exists or sysmon_unit_lib.stat.exists)

- name: Deploy Sysmon XML config
  template:
    src: sysmon-config.xml.j2
    dest: "{{ sysmon_config_path }}"
    owner: root
    group: root
    mode: '0644'
  notify: Restart sysmon
  become: true

- name: Enable and start Sysmon service candidates
  loop: "{{ sysmon_service_candidates }}"
  loop_control:
    label: "{{ item }}"
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  become: true
