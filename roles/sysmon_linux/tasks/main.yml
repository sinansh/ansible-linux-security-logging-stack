---
- name: Include OS-specific installation tasks
  include_tasks: "install-{{ ansible_facts['os_family'] }}.yml"

- name: Deploy custom Sysmon systemd unit from template
  template:
    src: sysmon.service.j2
    dest: /etc/systemd/system/sysmon.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Reload systemd

- name: Ensure Sysmon config directory exists
  file:
    path: "{{ sysmon_config_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Deploy Sysmon configuration
  template:
    src: sysmon-config.xml.j2
    dest: "{{ sysmon_config_path }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  register: sysmon_config_file

- name: Check if Sysmon service is active
  command: systemctl is-active sysmon
  register: sysmon_service_status
  failed_when: false
  changed_when: false
  become: true

- name: Install Sysmon configuration (First Time)
  command: >
    sysmon -i {{ sysmon_config_path }} -accepteula
  become: true
  when: (sysmon_service_status.rc | default(1)) != 0

- name: Update Sysmon configuration (Config Change)
  command: >
    sysmon -c {{ sysmon_config_path }}
  become: true
  when: 
    - (sysmon_service_status.rc | default(1)) == 0
    - sysmon_config_file.changed

- name: Ensure sysmon service is started and enabled
  systemd:
    name: sysmon
    state: started
    enabled: yes
    daemon_reload: yes
  become: true