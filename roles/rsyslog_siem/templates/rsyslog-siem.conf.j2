# 1. GEREKLİ MODÜLLERİ YÜKLE
# Dosya okumak için (audit.log)
module(load="imfile")

# NOT: imuxsock (sistem logları) genellikle rsyslog.conf ana dosyasında yüklüdür.
# Eğer yüklenmediyse hata almamak için şu satırın başındaki # işaretini kaldırın:
# module(load="imuxsock")

# 2. GÖNDERİM KURALI (Ruleset)
# Tekrarı önlemek için forwarding işlemini bir kural seti içine alıyoruz.
ruleset(name="SendToSIEM") {
    action(
        type="omfwd"
        target="{{ siem_host }}"
        port="{{ siem_port }}"
        protocol="{{ siem_protocol }}"
        # RSYSLOG_ForwardFormat: Standart, yüksek hassasiyetli zaman damgası içeren formattır.
        # SIEM tarafı bunu rahatlıkla parse eder.
        template="RSYSLOG_ForwardFormat"
        
        # Bağlantı koparsa logları kaybetmemek için disk kuyruğu (Opsiyonel ama önerilir)
        queue.type="LinkedList"
        queue.filename="siem_queue"
        queue.maxdiskspace="1g"
        queue.saveonshutdown="on"
        action.resumeRetryCount="-1"
    )
    stop # Log gönderildikten sonra yerel log dosyalarına yazılmasını engeller
}

# 3. AUDITD LOGLARINI OKU VE GÖNDER
input(type="imfile"
      File="/var/log/audit/audit.log"
      Tag="auditd"
      Ruleset="SendToSIEM" 
      # Audit logları çok hızlı aktığı için polling interval düşürülebilir (varsayılan genelde iyidir)
)

# 4. SYSMON LOGLARINI YAKALA VE GÖNDER
# Sysmon zaten sistem loglarına (syslog/journal) yazar. Buradan filtreleyip alıyoruz.
if ($programname == "sysmon" or $programname == "sysmonforlinux") then {
    call SendToSIEM
}