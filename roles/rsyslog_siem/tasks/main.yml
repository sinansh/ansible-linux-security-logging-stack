---
- name: Install rsyslog
  package:
    name: rsyslog
    state: present
  become: true

- name: Ensure ACL package is installed
  package:
    name: acl
    state: present
  become: true

- name: Grant syslog user access to audit directory
  acl:
    path: /var/log/audit
    entity: syslog
    etype: user
    permissions: rx
    state: present
  become: true

- name: Check if audit.log exists
  stat:
    path: /var/log/audit/audit.log
  register: audit_log_stat
  become: true

- name: Grant syslog user read access to audit.log
  acl:
    path: /var/log/audit/audit.log
    entity: syslog
    etype: user
    permissions: r
    state: present
  become: true
  when: audit_log_stat.stat.exists

- name: Deploy rsyslog SIEM forwarding config
  template:
    src: rsyslog-siem.conf.j2
    dest: /etc/rsyslog.d/99-siem.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart rsyslog
  become: true

- name: Ensure rsyslog is enabled and started
  systemd:
    name: rsyslog
    enabled: yes
    state: started
  become: true